name: Vault Anchor Write — Deterministic CI

on:
    push:
    pull_request:

jobs:
    verify:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install cryptography
              run: pip install cryptography

            # -------------------------------
            # 1. Verify payload hash
            # -------------------------------
            - name: Verify payload hash
              shell: python
              run: |
                  import json, hashlib, sys, pathlib

                  root = pathlib.Path("vault_anchor_write_v1_test_vectors")
                  payload = (root / "payload" / "canonical_payload.json").read_bytes()
                  expected = (root / "payload" / "payload_hash_sha256.txt").read_text().strip()

                  digest = hashlib.sha256(payload).hexdigest()

                  if digest != expected:
                      print("Payload hash mismatch")
                      print("Expected:", expected)
                      print("Actual:  ", digest)
                      sys.exit(1)

                  print("✓ Payload hash OK")

            # -------------------------------
            # 2. Verify pre-anchor signature
            # -------------------------------
            - name: Verify pre-anchor signature
              shell: python
              run: |
                  import base64, sys, pathlib
                  from cryptography.hazmat.primitives.asymmetric.ed25519 import Ed25519PublicKey
                  from cryptography.hazmat.primitives.serialization import load_der_public_key

                  root = pathlib.Path("vault_anchor_write_v1_test_vectors")

                  msg = (root / "pre_anchor" / "pre_anchor_jcs_bytes.txt").read_bytes()
                  pub_der = base64.b64decode((root / "keys" / "ed25519_public.base64").read_text().strip())
                  sig = base64.b64decode((root / "pre_anchor" / "pre_anchor_signature.base64").read_text().strip())

                  try:
                      pub_key = load_der_public_key(pub_der)
                      pub_key.verify(sig, msg)
                      print("✓ Pre-anchor signature OK")
                  except Exception as e:
                      print("Signature verification failed:", e)
                      sys.exit(1)

            # -------------------------------
            # 3. Verify anchor hash
            # -------------------------------
            - name: Verify anchor hash
              shell: python
              run: |
                  import hashlib, sys, pathlib

                  root = pathlib.Path("vault_anchor_write_v1_test_vectors")

                  jcs = (root / "final_receipt" / "final_receipt_jcs_bytes.txt").read_bytes()
                  expected = (root / "final_receipt" / "anchor_hash_sha256.txt").read_text().strip()

                  digest = hashlib.sha256(jcs).hexdigest()

                  if digest != expected:
                      print("Anchor hash mismatch")
                      print("Expected:", expected)
                      print("Actual:  ", digest)
                      sys.exit(1)

                  print("✓ Anchor hash OK")

            # -------------------------------
            # 4. Verify ledger line consistency
            # -------------------------------
            - name: Verify ledger line
              shell: python
              run: |
                  import json, sys, pathlib

                  root = pathlib.Path("vault_anchor_write_v1_test_vectors")

                  ledger_line = json.loads((root / "ledger" / "ledger_line.jsonl").read_text().strip())
                  final = json.loads((root / "final_receipt" / "final_receipt.json").read_text())

                  fields = [
                      "anchor_id",
                      "anchor_hash",
                      "artifact_kind",
                      "payload_hash",
                      "ts",
                      "vault_fingerprint"
                  ]

                  for f in fields:
                      if ledger_line.get(f) != final.get(f):
                          print(f"Ledger mismatch on field '{f}'")
                          print("Ledger:", ledger_line.get(f))
                          print("Final: ", final.get(f))
                          sys.exit(1)

                  print("✓ Ledger line OK")

    node_parity:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: ["18.x", "20.x"]

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}

            # Since strict parity tests aren't available in this concise script version,
            # we'll run a minimal check to ensure Node environment can read the JSONs
            # and they match basic expectations.
            - name: Minimal Node.js Verification
              run: |
                  node -e '
                    const fs = require("fs");
                    const path = require("path");
                    
                    const root = "vault_anchor_write_v1_test_vectors";
                    
                    // 1. Read Payload Hash
                    const payloadHash = fs.readFileSync(path.join(root, "payload", "payload_hash_sha256.txt"), "utf8").trim();
                    console.log("Payload Hash:", payloadHash);
                    
                    // 2. Read Final Receipt
                    const receipt = JSON.parse(fs.readFileSync(path.join(root, "final_receipt", "final_receipt.json"), "utf8"));
                    
                    if (receipt.schema_version !== "VaultFossilizationReceipt.v1") {
                        console.error("❌ Schema Mismatch");
                        process.exit(1);
                    }
                    console.log("✅ Node.js Parity Check Passed (Read/Parse OK)");
                  '
