<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replay Court Viewer ‚Äî Deterministic Verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #888;
            font-size: 0.9em;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
        }

        .upload-section:hover {
            border-color: rgba(0, 212, 255, 0.5);
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #00d4ff;
        }

        .status.error {
            border-left-color: #ff4444;
        }

        .status.success {
            border-left-color: #00ff88;
        }

        .ledger-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .entry-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .entry-card.active {
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .entry-tick {
            font-size: 1.2em;
            font-weight: bold;
            color: #00d4ff;
        }

        .hash-badge {
            padding: 4px 8px;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 4px;
            font-size: 0.8em;
            color: #00ff88;
        }

        .hash-badge.invalid {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .entry-details {
            display: grid;
            gap: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
        }

        .detail-label {
            color: #888;
            font-size: 0.85em;
        }

        .detail-value {
            font-family: 'Courier New', monospace;
            color: #e0e0e0;
            font-size: 0.85em;
        }

        .hash-display {
            word-break: break-all;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            font-size: 0.75em;
            color: #00d4ff;
        }

        .playback-slider {
            width: 100%;
            margin: 20px 0;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            color: #888;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .upload-heading {
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üî¨ Replay Court Viewer</h1>
            <p class="subtitle">Deterministic Ledger Verification & Playback</p>
        </header>

        <div class="upload-section">
            <label for="fileInput" class="upload-heading">
                <h3>üìÇ Load Ledger (NDJSON)</h3>
            </label>
            <input type="file" id="fileInput" accept=".ndjson,.jsonl,.json"
                aria-label="Load ledger file (NDJSON, JSONL, or JSON format)">
        </div>

        <div id="status" class="status hidden"></div>

        <div class="stats-grid hidden" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalTicks">0</div>
                <div class="stat-label">Total Ticks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="validHashes">0</div>
                <div class="stat-label">Valid Hashes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="chainIntegrity">‚Äî</div>
                <div class="stat-label">Chain Integrity</div>
            </div>
        </div>

        <div class="controls hidden" id="controls">
            <button id="playBtn">‚ñ∂Ô∏è Play</button>
            <button id="pauseBtn" disabled>‚è∏Ô∏è Pause</button>
            <button id="prevBtn">‚èÆÔ∏è Previous</button>
            <button id="nextBtn">‚è≠Ô∏è Next</button>
            <button id="resetBtn">üîÑ Reset</button>
        </div>

        <input type="range" id="playbackSlider" class="playback-slider hidden" min="0" max="0" value="0">

        <div class="ledger-view" id="ledgerView"></div>
    </div>

    <script>
        let ledgerEntries = [];
        let currentIndex = 0;
        let isPlaying = false;
        let playInterval = null;

        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const controls = document.getElementById('controls');
        const ledgerView = document.getElementById('ledgerView');
        const playbackSlider = document.getElementById('playbackSlider');
        const statsGrid = document.getElementById('statsGrid');

        fileInput.addEventListener('change', handleFileUpload);
        document.getElementById('playBtn').addEventListener('click', play);
        document.getElementById('pauseBtn').addEventListener('click', pause);
        document.getElementById('prevBtn').addEventListener('click', () => seek(currentIndex - 1));
        document.getElementById('nextBtn').addEventListener('click', () => seek(currentIndex + 1));
        document.getElementById('resetBtn').addEventListener('click', () => seek(0));
        playbackSlider.addEventListener('input', (e) => seek(parseInt(e.target.value)));

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                showStatus('Loading ledger...', 'status');
                let text = await file.text();

                // Remove BOM if present
                if (text.charCodeAt(0) === 0xFEFF) {
                    text = text.slice(1);
                }

                // Parse NDJSON with better error handling
                const lines = text.trim().split('\n');
                ledgerEntries = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // Skip empty lines

                    try {
                        const entry = JSON.parse(line);
                        ledgerEntries.push(entry);
                    } catch (parseError) {
                        console.error(`Error parsing line ${i + 1}:`, line);
                        showStatus(`‚ùå Error parsing line ${i + 1}: ${parseError.message}`, 'error');
                        return;
                    }
                }

                if (ledgerEntries.length === 0) {
                    showStatus('‚ùå No valid entries found in file', 'error');
                    return;
                }

                showStatus(`‚úÖ Loaded ${ledgerEntries.length} entries`, 'success');

                // Verify hashes
                verifyLedger();

                // Initialize UI
                controls.classList.remove('hidden');
                playbackSlider.classList.remove('hidden');
                playbackSlider.max = ledgerEntries.length - 1;
                statsGrid.classList.remove('hidden');

                // Show first entry
                seek(0);
            } catch (error) {
                console.error('File upload error:', error);
                showStatus(`‚ùå Error loading file: ${error.message}`, 'error');
            }
        }

        function verifyLedger() {
            let validCount = 0;
            let chainValid = true;
            let prevHash = null;

            for (let i = 0; i < ledgerEntries.length; i++) {
                const entry = ledgerEntries[i];

                // Simple hash validation (assumes hash field exists)
                if (entry.hash || entry.checkpoint_hash || entry.ledger_head_hash) {
                    validCount++;
                }

                // Chain validation
                if (i > 0) {
                    const expectedPrev = ledgerEntries[i - 1].hash ||
                        ledgerEntries[i - 1].checkpoint_hash ||
                        ledgerEntries[i - 1].ledger_head_hash;
                    const actualPrev = entry.previousHash ||
                        entry.prev_checkpoint_hash ||
                        entry.prev_hash;

                    if (expectedPrev && actualPrev && expectedPrev !== actualPrev) {
                        chainValid = false;
                    }
                }
            }

            // Update stats
            document.getElementById('totalTicks').textContent = ledgerEntries.length;
            document.getElementById('validHashes').textContent = validCount;
            document.getElementById('chainIntegrity').textContent = chainValid ? '‚úÖ INTACT' : '‚ùå BROKEN';
        }

        function seek(index) {
            currentIndex = Math.max(0, Math.min(index, ledgerEntries.length - 1));
            playbackSlider.value = currentIndex;
            render();
        }

        function play() {
            isPlaying = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;

            playInterval = setInterval(() => {
                if (currentIndex >= ledgerEntries.length - 1) {
                    pause();
                } else {
                    seek(currentIndex + 1);
                }
            }, 1000);
        }

        function pause() {
            isPlaying = false;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            clearInterval(playInterval);
        }

        function render() {
            ledgerView.innerHTML = '';

            const current = ledgerEntries[currentIndex];
            const prev = currentIndex > 0 ? ledgerEntries[currentIndex - 1] : null;

            // Current entry card
            const currentCard = createEntryCard(current, currentIndex, true);
            ledgerView.appendChild(currentCard);

            // Previous entry card (for comparison)
            if (prev) {
                const prevCard = createEntryCard(prev, currentIndex - 1, false);
                ledgerView.appendChild(prevCard);
            }
        }

        function createEntryCard(entry, index, isActive) {
            const card = document.createElement('div');
            card.className = `entry-card ${isActive ? 'active' : ''}`;

            const hash = entry.hash || entry.checkpoint_hash || entry.ledger_head_hash || 'N/A';
            const tick = entry.tick !== undefined ? entry.tick : index;

            card.innerHTML = `
                <div class="entry-header">
                    <div class="entry-tick">Tick ${tick}</div>
                    <div class="hash-badge">‚úì Valid</div>
                </div>
                <div class="entry-details">
                    <div class="detail-row">
                        <span class="detail-label">ID:</span>
                        <span class="detail-value">${entry.id || entry.capsule_id || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Agent:</span>
                        <span class="detail-value">${entry.agentId || entry.agent || 'SYSTEM'}</span>
                    </div>
                    ${entry.timestamp ? `
                    <div class="detail-row">
                        <span class="detail-label">Timestamp:</span>
                        <span class="detail-value">${new Date(entry.timestamp).toLocaleTimeString()}</span>
                    </div>
                    ` : ''}
                    <div style="margin-top: 10px;">
                        <div class="detail-label" style="margin-bottom: 5px;">Hash:</div>
                        <div class="hash-display">${hash.substring(0, 64)}${hash.length > 64 ? '...' : ''}</div>
                    </div>
                    ${entry.previousHash || entry.prev_checkpoint_hash ? `
                    <div style="margin-top: 10px;">
                        <div class="detail-label" style="margin-bottom: 5px;">Previous Hash:</div>
                        <div class="hash-display">${(entry.previousHash || entry.prev_checkpoint_hash || 'null').substring(0, 64)}</div>
                    </div>
                    ` : ''}
                </div>
            `;

            return card;
        }

        function showStatus(message, type = 'status') {
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
        }
    </script>
</body>

</html>